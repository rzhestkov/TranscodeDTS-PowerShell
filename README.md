# TranscodeDTS-PowerShell

## Кратко

Запуск: **transCodeDTS.cmd** 

## Проблематика

Современные телевизоры LG и Samsung имеют отличный встроенный плеер, который может проигрывать файлы (контейнеры) различных форматов через DLNA в максимальном качестве. Встроенный плеер понимает множество аудиодорожек и может переключаться между ними. Но в силу лицензионных ограничений в современных телевизорах не проигрываются аудиопотоки (аудиодорожки) форматов DTS и некоторых других.

DTS - популярный формат звука для видеофайлов, т.к., похоже, что это нативный формат при издании фильмов на BlueRay.

Аудиопотоки формата DTS просто не видятся плеером.

## Цели

Сделать файлы, в которых все звуковые дорожки видятся и проигрываются встроенным плеером. 

Добиться минимального перекодирования файлов. В идеале, должны будут перекодированы только аудиодорожки формата DTS, а остальное содержимое контейнера должно остаться нетронутым.

## Что делает программа

1. В текущей папке ищет все файлы форматов .mp4, .mkv

2. У каждого файла проверяет используемые аудиокодеки для всех аудиодорожек

3. Перекодирует с помощью **ffmpeg** аудиодорожки, в описаниях которых есть truehd, dts, flac.

Исходные файлы остаются неизменными. Создаются новые перекодированные файлы рядом.
Видеодорожки переносятся в новые файлы без изменений.
Аудиодорожки с некоторыми кодеками перекодируются. Шаблон их поиска - в переменной `$streamsToTranscode`.

Аудиодорожки - те, которые не перекодируются, переносятся без изменений.
Субтитры - переносятся в новый файл без изменений.
Метаданные всех потоков сохраняются без изменений.
Если есть еще какие-то потоки, они не переносятся.

## Порядок работы

#### 1. Установка

<u><em>Нужно, чтобы в операционной системе было разрешено исполнение PowerShell скриптов. Без этого работать ничего не будет.</em></u>

В папку с файлами (фильмами) для обработки нужно скопировать файлы:

ffmpeg.exe

transCodeDTS.ps1

transCodeDTS.cmd

#### 2. Обработка

Обработка запускается вызовом **transCodeDTS.cmd** из папки, где расположены обрабатываемые файлы (фильмы).

#### 3. Возможные настройки

Все настройки делаются в коде в **transCodeDTS.ps1**.

Можно менять маску поиска файлов (фильмов) для перекодирования: 

`$FileList= Get-ChildItem -Path $cur_path -Force -ErrorAction SilentlyContinue -File -Name -Include @("*.mp4", "*.mkv")` путем добавления/изменения фрагментов , `"*.mkv"`. 

Можно изменять маску поиска аудиопотоков в строке:

`$streamsToTranscode='Audio: (truehd|dts|flac)'`

Можно изменять способ перекодирования аудиопотоков в строке:

`$transcodeCommand=' ac3 -b:a 448k '`.

Если что-то идет не так, можно читать текстовые файлы диагностики, которые процессе рождает **ffmpeg.exe**. Для этого нужно поставить комментарий `#` переl строкой `$delTxtLogs=$true`.

## Ограничения

Перекодирования аудиодорожек производится в ac3 448 kbit/s (стерео). Это конечно не тоже самое, что DTS, который содержит обычно 5 каналов. Но для проигрывания на телевизоре - вполне достаточно.

Ссылок для скачивания ffmpeg здесь нет. Они гуглятся.

## Разное

Данный скрипт писался в 2022 году и ориентировался на синтаксис, который поддерживает **ffmpeg** тех версий. На сколько я понял из мануалов, используется обновленный синтаксис работы с потоками. Он не должен изменяться в новых версиях **ffmpeg** в ближайшие годы.

Остальные команды - стандартные и должны работать в разных сборках **ffmpeg**


